# Disclaimer - Work in progress

The repository you are looking into is work in progress.

It contains proof of concept and preview builds in development created in context of the [openDesk](https://gitlab.opencode.de/bmi/souveraener_arbeitsplatz/info) project.

The repository's content provides you with first insights into the containerized cloud IAM from Univention, derived from the UCS appliance.

# End-to-end tests used by the SouvAP Dev team

## Requirements

Make sure to have `pipenv` available, see <https://pipenv.pypa.io/en/latest/>.

## Installation

The installation is only needed once.

```
pipenv sync
pipenv shell

playwright install  # installs required browsers
```

## How to run tests

Use Docker, see below.

We use the `pytest-playwright` plugin, and it exposes useful command
line options for running end-to-end tests. See [all available options](https://playwright.dev/python/docs/test-runners).

Here are **some** useful ones:

1. `--headed`: Run tests in headed mode.
2. `--slowmo`: Run tests in slow motion e.g. `--slowmo 500`
3. `--video`: Capture video e.g. `--video on`
4. `--browser`: Use a specific browser `--browser firefox`

### Pipeline

Go to the [pipelines](https://git.knut.univention.de/univention/customers/dataport/upx/e2e-tests/-/pipelines)
of this repo and run the pipeline with the following variables:

- `TEST_PORTAL_BASE_URL`: The base URL of the portal to test. Example: `https://portal.uv-username.gaia.open-desk.cloud/univention/portal/`.

The pipeline will use the default secrets for Gaia. But you can override them by
setting `ADMIN_PASSWORD`, `USER_PASSWORD`, and `UDM_ADMIN_PASSWORD`.

### Running with `docker`

First, set up the dev-env, including the ingress and forwading the host port 8000 to it.

Then, run the following commands:

```shell
docker build -t e2e:latest .
docker run -it --network="host" e2e:latest
```

Alternatively, you can directly test against the acceptance environment. In
order to get the preconfigured credentials, you should specify
`sovereign-workplace` in the `MASTER_PASSWORD_WEB_VAR` on openDesk pipeline.
Once finished, run the following command:

```shell
docker run -it --network="host" \
  -e NAMESPACE=uv-username \
  -e ADMIN_PASSWORD=secret \
  -e USER_PASSWORD=secret \
  -e UDM_ADMIN_PASSWORD=secret \
  e2e:latest
```

You can always override the value of `PYTEST_ADDOPTS` generated by the
`entrypoint.sh` with the `-e` flag, and/or run a custom command. Example:

```shell
docker run -it --network="host" -e PYTEST_ADDOPTS="..." e2e:latest pytest --pdb
```

Or just override one (or many) of the `PYTEST_ADDOPTS` flags:

```shell
docker run -it --network="host" e2e:latest pytest --password custom_password
```

## For test engineers

We use the page object model in our tests. The page objects are in `src/umspages`.

You can pip install the page objects as a package using

```
pip install -e .
```

While this is not strictly necessary to run the tests (`pytest` finds the necessary
packages using the `[tool.pytest.ini_options]` in `pyproject.toml`), this will
help the IDE in autocompletion etc., and generally improve the development
experience.

We have a [guide on writing Page Objects, tests and fixtures](guidelines.md).

## Available tests

The brief description of every test in this repo can be found [here](tests.md).

## Processes

Our test management process is documented [here](https://univention.gitpages.knut.univention.de/customers/dataport/team-souvap/testing/test-management.html).
